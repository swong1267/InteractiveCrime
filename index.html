<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>CS448B Assignment 3</title>
        <script type="text/javascript" src="d3/d3.js"></script>
<!--         <script type="text/javascript" src="slider/js/bootstrap-slider.js"></script>s
 -->        <link rel="stylesheet" type="text/css" href="index.css">
<!--         <link rel="stylesheet" type="text/css" href="slider/css/slider.css">
 -->        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    </head>
	    <body>

	   	<div id="header">
	   		<h1> City of San Francisco Interactive Crime Map | April 1 - 15, 2016 </h1>
	   	</div>

	    <div id="map-area">
	        <script type="text/javascript">

                var filters = [];
                var catCount = 0; //1
                var timeCount = 0; //2
                var dayCount = 0 //3
	            var data;
	            var ptax;
	            var ptay;
	            var ptbx;
	            var ptby;
	            var pxpermile = 60.5; 
	            var radiusa = 2 * pxpermile; 
	            var radiusb = 2 * pxpermile;

	            d3.json("scpd_incidents.json", function(error, json) {
	                console.log(json);
	                data = json;
	                visualize(data);

	            });

	            // Set up size
	            var width = 750,
	                height = width;

	            // Set up projection that map is using
	            var projection = d3.geo.mercator()
	                .center([-122.433701, 37.767683]) // San Francisco, roughly
	                .scale(225000)
	                .translate([width / 2, height / 2]);
	            // This is the mapping between <longitude, latitude> position to <x, y> pixel position on the map
	            // projection([lon, lat]) returns [x, y]

	            // Add an svg element to the DOM
	            var svg = d3.select("body").append("svg")
	                .attr("width", width)
	                .attr("height", height);

	            // Add svg map at correct size, assumes map is saved in a subdirectory called "data"
	            svg.append("image")
	                      .attr("width", width)
	                      .attr("height", height)
	                      .attr("xlink:href", "data/sf-map.svg");




                function visualize(data, filters) {
                    var colorScale = d3.scale.category10();
                    var circles = svg.selectAll("circle").data(data.data);
                    circles.enter()
                        .append("circle")
                        .attr("r", "4px")
                        .attr("data-id", function(incident) {return incident.IncidentNumber; })
                        .attr("cx", function(incident) {return projection(incident.Location)[0]; })
                        .attr("cy", function(incident) {return projection(incident.Location)[1]; })
                        .attr("fill", function(incident) {return colorScale(incident.Category); });
                    circles.exit().remove();
                    var counter = d3.selectAll("h2").text("Number of Incidents: " + data.data.length);
                }





                function filter(filter_btn){

                    var index = filters.indexOf(filter_btn.value);
                    console.log(filter_btn.name);

                    console.log(filters);
                    console.log("catCount: " + catCount + " timeCount: " + timeCount + " dayCount:" + dayCount);
                    if (index == -1) {
                        filters.push(filter_btn.value);
                        changeCount(filter_btn.name, 1);
                        console.log(filters);
                        console.log("catCount: " + catCount + " timeCount: " + timeCount + " dayCount:" + dayCount);
                    } else {
                        filters.splice(index, 1);
                        changeCount(filter_btn.name, -1);
                        console.log(filters);
                        console.log("catCount: " + catCount + " timeCount: " + timeCount + " dayCount:" + dayCount);
                    }

                    filter_data();
                };

                function changeCount(count, value) {

                    if (count == 1) {
                        catCount = catCount + value;
                    } else if (count == 2) {
                        timeCount = timeCount + value;
                    } else {
                        dayCount = dayCount + value;
                    }
                }


                function filter_data() {
                    var colorScale = d3.scale.category10();

                    if (filters.length == 0) {
                        svg.selectAll("circle").data(data.data)
                        .attr("fill", function(incident) {return colorScale(incident.Category); });
                    } else {
                        svg.selectAll("circle").data(data.data)
                        .filter(function(d) {
                            var catIndex = filters.indexOf(d.Category);
                            var dayIndex = filters.indexOf(d.DayOfWeek);

                            var convertedTime = convertTime(d.Time);
                            var timeIndex = filters.indexOf(convertedTime);

                            return (catIndex == -1 || dayIndex == -1 || timeIndex == -1) //no filters apply
                        })
                        .attr("fill", "transparent");

                        svg.selectAll("circle").data(data.data)
                        .filter(function(d) {
                            var catIndex = filters.indexOf(d.Category);
                            var dayIndex = filters.indexOf(d.DayOfWeek);

                            var convertedTime = convertTime(d.Time);
                            var timeIndex = filters.indexOf(convertedTime);

                            return !((catCount > 0 && catIndex == -1) || (timeCount > 0 && timeIndex == -1) || (dayCount > 0 && dayIndex == -1))
                        })
                        .attr("fill", function(incident) {return colorScale(incident.Category); });
                    }
                }

                function convertTime(time) {
                    if (Date.parse('01/01/2011 ' + time) > Date.parse('01/01/2011 18:00:00'))
                        return "4";
                    else if (Date.parse('01/01/2011 ' + time) > Date.parse('01/01/2011 12:00:00'))
                        return "3";
                    else if (Date.parse('01/01/2011 ' + time) > Date.parse('01/01/2011 6:00:00'))
                        return "2";
                    else
                        return "1";
                }

	            var clickCount = 1;

	            svg.on("click", function() {
	            	var coord = d3.mouse(this);
	            	if(clickCount % 2 == 1) {

	            		if(clickCount > 1) {
	            			svg.select("#point1").remove();
	            			svg.select("#point1-radius").remove();
	            		}

	            		ptax = coord[0];
	            		ptay = coord[1];

		            	svg.append("circle")
		            		.attr("id", "point1")
		            		.attr("transform", "translate(" + ptax + "," + ptay + ")")
		            		.attr("r", "10")
		            		.attr("class", "location")
		            		.style("fill", "#FF00FF")
		            		.style("stroke", "black")
		            		.style("stroke-width", 2)

		            	proj1 = projection.invert(coord); 

		            	svg.append("circle")
		            		.attr("id", "point1-radius")
		            		.attr("transform", "translate(" + ptax + "," + ptay + ")")
		            		.attr("r", radiusa)
		            		.style("fill", "none")
		            		.style("stroke", "#FF00FF")
		            		.style("stroke-width", 2)

		            } else {

		            	if(clickCount > 2) {
	            			svg.select("#point2").remove();
	            			svg.select("#point2-radius").remove();
	            		}

		            	ptbx = coord[0];
		            	ptby = coord[1];

		            	svg.append("circle")
		            		.attr("id", "point2")
		            		.attr("transform", "translate(" + ptbx + "," + ptby + ")")
		            		.attr("r", "10")
		            		.attr("class", "location")
		            		.style("fill", "#00FFFF")
		            		.style("stroke", "black")
		            		.style("stroke-width", 2)

		            	proj2 = projection.invert(coord); 

		            	svg.append("circle")
		            		.attr("id", "point2-radius")
		            		.attr("transform", "translate(" + ptbx + "," + ptby + ")")
		            		.attr("r", radiusb)
		            		.style("fill", "none")
		            		.style("stroke", "#00FFFF")
		            		.style("stroke-width", 2)

		            }
		            clickCount++;
	            })

	        </script>
	    </div>

	    <div id="filter-area" class="panel panel-default">
			<div class="panel-heading"> <h2> Filters </h2> </div>
			<div id="radius-selection">
				<h3> Radius </h3>
				<p> A </p>
				<textarea class="form-control" rows="1" id="radiusainput"></textarea>
				<button onclick="populate()" id="radiusabutton">Enter</button>
				<script>
					function populate()
					{
						radiusa = document.getElementById("radiusainput").value; 
					}

					console.log("HERE"+radiusa);
				</script>
<!-- 				<b> 0 mi </b> <input id="slidera" type="text" class="span2" value="" data-slider-min="0" data-slider-max="7" data-slider-step="1" data-slider-value="3"/> <b> 7 mi </b>
				<script> 
					var slider = new Slider('#slidera', {});
				</script> -->
				<p> B </p>
			</div>
			<div id="district-category">
				<div id="district">
					<h3> Day of Week </h3>
                        <div class="checkbox">
                            <label><input type="checkbox" name="3" value="Sunday" onchange="filter(this)">Sunday</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" name="3" value="Monday" onchange="filter(this)">Monday</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" name="3" value="Tuesday" onchange="filter(this)">Tuesday</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" name="3" value="Wednesday" onchange="filter(this)">Wednesday</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" name="3" value="Thursday" onchange="filter(this)">Thursday</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" name="3" value="Friday" onchange="filter(this)">Friday</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" name="3" value="Saturday" onchange="filter(this)">Saturday</label>
                        </div>
				</div>
				<div id="category">
					<h3> Category </h3>
				</div>
			</div>
			<div id="time-of-day">
				<h3> Time of Day </h3>
					<div id="daytime">
						<div class="checkbox">
							<label><input type="checkbox" name="2" value="1" onchange="filter(this)">6am - 12pm</label>
						</div>
						<div class="checkbox">
						 	<label><input type="checkbox" name="2" value="2" onchange="filter(this)">12pm - 6pm</label>
						</div>
					</div>
					<div id="nighttime">
						<div class="checkbox">
							<label><input type="checkbox" name="2" value="3" onchange="filter(this)">6pm - 12am</label>
						</div>
						<div class="checkbox">
							<label><input type="checkbox" name="2" value="4" onchange="filter(this)">12am - 6am</label>
						</div>
					</div>
			</div>
	    </div>
    </body>
</html>